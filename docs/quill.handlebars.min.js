var quillHandlebars=function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function i(t,e,i){return e&&n(t.prototype,e),i&&n(t,i),t}function s(){return(s=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i])}return t}).apply(this,arguments)}function a(t){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function r(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function h(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var n,i=a(t);if(e){var s=a(this).constructor;n=Reflect.construct(i,arguments,s)}else n=i.apply(this,arguments);return r(this,n)}}function l(t,e,n){return(l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(t,e,n){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=a(t)););return t}(t,e);if(i){var s=Object.getOwnPropertyDescriptor(i,e);return s.get?s.get.call(n):s.value}})(t,e,n||t)}t=t&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t;var d=9,u=13,c=27,b=38,f=40;function p(t,e,n){var i=t;return Object.keys(e).forEach((function(t){n.indexOf(t)>-1?i.dataset[t]=e[t]:delete i.dataset[t]})),i}var g=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&o(t,e)}(s,t);var n=h(s);function s(){return e(this,s),n.apply(this,arguments)}return i(s,null,[{key:"create",value:function(t){var e=l(a(s),"create",this).call(this),n=document.createElement("span");return n.className="ql-handlebars-denotation-char",n.innerHTML=t.denotationChar,e.appendChild(n),e.innerHTML+=t.value+"}}",s.setDataValues(e,t)}},{key:"setDataValues",value:function(t,e){var n=t;return Object.keys(e).forEach((function(t){n.dataset[t]=e[t]})),n}},{key:"value",value:function(t){return t.dataset}}]),s}(t.import("blots/embed"));g.blotName="handlebars",g.tagName="span",g.className="handlebars",t.register(g);var m=function(){function n(t,i){e(this,n),this.isOpen=!1,this.itemIndex=0,this.handlebarsCharPos=null,this.cursorPos=null,this.values=[],this.suspendMouseEnter=!1,this.existingSourceExecutionToken=null,this.quill=t,this.options={source:null,renderItem:function(t){return"".concat(t.value)},renderLoading:function(){return null},onSelect:function(t,e){e(t)},handlebarsDenotationChars:["{{"],showDenotationChar:!0,allowedChars:/^[a-zA-Z0-9_]*$/,minChars:0,maxChars:31,offsetTop:2,offsetLeft:0,isolateCharacter:!1,fixHandlebarsToQuill:!1,positioningStrategy:"normal",defaultMenuOrientation:"bottom",blotName:"handlebars",dataAttributes:["id","value","denotationChar","link","target","disabled"],linkTarget:"_blank",onOpen:function(){return!0},onClose:function(){return!0},listItemClass:"ql-handlebars-list-item",handlebarsContainerClass:"ql-handlebars-list-container",handlebarsListClass:"ql-handlebars-list",spaceAfterInsert:!0},s(this.options,i,{dataAttributes:Array.isArray(i.dataAttributes)?this.options.dataAttributes.concat(i.dataAttributes):this.options.dataAttributes}),this.handlebarsContainer=document.createElement("div"),this.handlebarsContainer.className=this.options.handlebarsContainerClass?this.options.handlebarsContainerClass:"",this.handlebarsContainer.style.cssText="display: none; position: absolute;",this.handlebarsContainer.onmousemove=this.onContainerMouseMove.bind(this),this.options.fixHandlebarsToQuill&&(this.handlebarsContainer.style.width="auto"),this.handlebarsList=document.createElement("ul"),this.handlebarsList.className=this.options.handlebarsListClass?this.options.handlebarsListClass:"",this.handlebarsContainer.appendChild(this.handlebarsList),t.on("text-change",this.onTextChange.bind(this)),t.on("selection-change",this.onSelectionChange.bind(this)),t.keyboard.addBinding({key:d},this.selectHandler.bind(this)),t.keyboard.bindings[d].unshift(t.keyboard.bindings[d].pop()),t.keyboard.addBinding({key:u},this.selectHandler.bind(this)),t.keyboard.bindings[u].unshift(t.keyboard.bindings[u].pop()),t.keyboard.addBinding({key:c},this.escapeHandler.bind(this)),t.keyboard.addBinding({key:b},this.upHandler.bind(this)),t.keyboard.addBinding({key:f},this.downHandler.bind(this))}return i(n,[{key:"selectHandler",value:function(){return!(this.isOpen&&!this.existingSourceExecutionToken)||(this.selectItem(),!1)}},{key:"escapeHandler",value:function(){return!this.isOpen||(this.existingSourceExecutionToken&&(this.existingSourceExecutionToken.abandoned=!0),this.hideHandlebarsList(),!1)}},{key:"upHandler",value:function(){return!(this.isOpen&&!this.existingSourceExecutionToken)||(this.prevItem(),!1)}},{key:"downHandler",value:function(){return!(this.isOpen&&!this.existingSourceExecutionToken)||(this.nextItem(),!1)}},{key:"showHandlebarsList",value:function(){"fixed"===this.options.positioningStrategy?document.body.appendChild(this.handlebarsContainer):this.quill.container.appendChild(this.handlebarsContainer),this.handlebarsContainer.style.visibility="hidden",this.handlebarsContainer.style.display="",this.handlebarsContainer.scrollTop=0,this.setHandlebarsContainerPosition(),this.setIsOpen(!0)}},{key:"hideHandlebarsList",value:function(){this.handlebarsContainer.style.display="none",this.handlebarsContainer.remove(),this.setIsOpen(!1)}},{key:"highlightItem",value:function(){for(var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],e=0;e<this.handlebarsList.childNodes.length;e+=1)this.handlebarsList.childNodes[e].classList.remove("selected");if(-1!==this.itemIndex&&"true"!==this.handlebarsList.childNodes[this.itemIndex].dataset.disabled&&(this.handlebarsList.childNodes[this.itemIndex].classList.add("selected"),t)){var n=this.handlebarsList.childNodes[this.itemIndex].offsetHeight,i=this.handlebarsList.childNodes[this.itemIndex].offsetTop,s=this.handlebarsContainer.scrollTop,a=s+this.handlebarsContainer.offsetHeight;i<s?this.handlebarsContainer.scrollTop=i:i>a-n&&(this.handlebarsContainer.scrollTop+=i-a+n)}}},{key:"getItemData",value:function(){var t=this.handlebarsList.childNodes[this.itemIndex].dataset.link,e=void 0!==t,n=this.handlebarsList.childNodes[this.itemIndex].dataset.target;return e&&(this.handlebarsList.childNodes[this.itemIndex].dataset.value='<a href="'.concat(t,'" target=').concat(n||this.options.linkTarget,">").concat(this.handlebarsList.childNodes[this.itemIndex].dataset.value)),this.handlebarsList.childNodes[this.itemIndex].dataset}},{key:"onContainerMouseMove",value:function(){this.suspendMouseEnter=!1}},{key:"selectItem",value:function(){var t=this;if(-1!==this.itemIndex){var e=this.getItemData();e.disabled||(this.options.onSelect(e,(function(e){t.insertItem(e)})),this.hideHandlebarsList())}}},{key:"insertItem",value:function(e,n){var i,s=e;null!==s&&(this.options.showDenotationChar||(s.denotationChar=""),n?i=this.cursorPos:(i=this.handlebarsCharPos,this.quill.deleteText(this.handlebarsCharPos,this.cursorPos-this.handlebarsCharPos,t.sources.USER)),this.quill.insertEmbed(i,this.options.blotName,s,t.sources.USER),this.options.spaceAfterInsert?(this.quill.insertText(i+1," ",t.sources.USER),this.quill.setSelection(i+2,t.sources.USER)):this.quill.setSelection(i+1,t.sources.USER),this.hideHandlebarsList())}},{key:"onItemMouseEnter",value:function(t){if(!this.suspendMouseEnter){var e=Number(t.target.dataset.index);Number.isNaN(e)||e===this.itemIndex||(this.itemIndex=e,this.highlightItem(!1))}}},{key:"onDisabledItemMouseEnter",value:function(t){this.suspendMouseEnter||(this.itemIndex=-1,this.highlightItem(!1))}},{key:"onItemClick",value:function(t){0===t.button&&(t.preventDefault(),t.stopImmediatePropagation(),this.itemIndex=t.currentTarget.dataset.index,this.highlightItem(),this.selectItem())}},{key:"onItemMouseDown",value:function(t){t.preventDefault(),t.stopImmediatePropagation()}},{key:"renderLoading",value:function(){if(this.options.renderLoading())if(this.handlebarsContainer.getElementsByClassName("ql-handlebars-loading").length>0)this.showHandlebarsList();else{this.handlebarsList.innerHTML="";var t=document.createElement("div");t.className="ql-handlebars-loading",t.innerHTML=this.options.renderLoading(),this.handlebarsContainer.append(t),this.showHandlebarsList()}}},{key:"removeLoading",value:function(){var t=this.handlebarsContainer.getElementsByClassName("ql-handlebars-loading");t.length>0&&t[0].remove()}},{key:"renderList",value:function(t,e,n){if(e&&e.length>0){this.removeLoading(),this.values=e,this.handlebarsList.innerHTML="";for(var i=-1,s=0;s<e.length;s+=1){var a=document.createElement("li");a.className=this.options.listItemClass?this.options.listItemClass:"",e[s].disabled?a.className+=" disabled":-1===i&&(i=s),a.dataset.index=s,a.innerHTML=this.options.renderItem(e[s],n),e[s].disabled?a.onmouseenter=this.onDisabledItemMouseEnter.bind(this):(a.onmouseenter=this.onItemMouseEnter.bind(this),a.onmouseup=this.onItemClick.bind(this),a.onmousedown=this.onItemMouseDown.bind(this)),a.dataset.denotationChar=t,this.handlebarsList.appendChild(p(a,e[s],this.options.dataAttributes))}this.itemIndex=i,this.highlightItem(),this.showHandlebarsList()}else this.hideHandlebarsList()}},{key:"nextItem",value:function(){var t,e=0;do{e++,t=(this.itemIndex+e)%this.values.length;var n="true"===this.handlebarsList.childNodes[t].dataset.disabled;if(e===this.values.length+1){t=-1;break}}while(n);this.itemIndex=t,this.suspendMouseEnter=!0,this.highlightItem()}},{key:"prevItem",value:function(){var t,e=0;do{e++,t=(this.itemIndex+this.values.length-e)%this.values.length;var n="true"===this.handlebarsList.childNodes[t].dataset.disabled;if(e===this.values.length+1){t=-1;break}}while(n);this.itemIndex=t,this.suspendMouseEnter=!0,this.highlightItem()}},{key:"containerBottomIsNotVisible",value:function(t,e){return t+this.handlebarsContainer.offsetHeight+e.top>window.pageYOffset+window.innerHeight}},{key:"containerRightIsNotVisible",value:function(t,e){return!this.options.fixHandlebarsToQuill&&t+this.handlebarsContainer.offsetWidth+e.left>window.pageXOffset+document.documentElement.clientWidth}},{key:"setIsOpen",value:function(t){this.isOpen!==t&&(t?this.options.onOpen():this.options.onClose(),this.isOpen=t)}},{key:"setHandlebarsContainerPosition",value:function(){"fixed"===this.options.positioningStrategy?this.setHandlebarsContainerPosition_Fixed():this.setHandlebarsContainerPosition_Normal()}},{key:"setHandlebarsContainerPosition_Normal",value:function(){var t=this,e=this.quill.container.getBoundingClientRect(),n=this.quill.getBounds(this.handlebarsCharPos),i=this.handlebarsContainer.offsetHeight,s=this.options.offsetTop,a=this.options.offsetLeft;if(this.options.fixHandlebarsToQuill){this.handlebarsContainer.style.right="".concat(0,"px")}else a+=n.left;if(this.containerRightIsNotVisible(a,e)){var o=this.handlebarsContainer.offsetWidth+this.options.offsetLeft;a=e.width-o}if("top"===this.options.defaultMenuOrientation){if((s=this.options.fixHandlebarsToQuill?-1*(i+this.options.offsetTop):n.top-(i+this.options.offsetTop))+e.top<=0){var r=this.options.offsetTop;this.options.fixHandlebarsToQuill?r+=e.height:r+=n.bottom,s=r}}else if(this.options.fixHandlebarsToQuill?s+=e.height:s+=n.bottom,this.containerBottomIsNotVisible(s,e)){var h=-1*this.options.offsetTop;this.options.fixHandlebarsToQuill||(h+=n.top),s=h-i}s>=0?this.options.handlebarsContainerClass.split(" ").forEach((function(e){t.handlebarsContainer.classList.add("".concat(e,"-bottom")),t.handlebarsContainer.classList.remove("".concat(e,"-top"))})):this.options.handlebarsContainerClass.split(" ").forEach((function(e){t.handlebarsContainer.classList.add("".concat(e,"-top")),t.handlebarsContainer.classList.remove("".concat(e,"-bottom"))})),this.handlebarsContainer.style.top="".concat(s,"px"),this.handlebarsContainer.style.left="".concat(a,"px"),this.handlebarsContainer.style.visibility="visible"}},{key:"setHandlebarsContainerPosition_Fixed",value:function(){var t=this;this.handlebarsContainer.style.position="fixed",this.handlebarsContainer.style.height=null;var e=this.quill.container.getBoundingClientRect(),n=this.quill.getBounds(this.handlebarsCharPos),i={left:e.left+n.left,top:e.top+n.top,width:0,height:n.height},s=this.options.fixHandlebarsToQuill?e:i,a=this.options.offsetTop,o=this.options.offsetLeft;if(this.options.fixHandlebarsToQuill){var r=s.right;this.handlebarsContainer.style.right="".concat(r,"px")}else(o+=s.left)+this.handlebarsContainer.offsetWidth>document.documentElement.clientWidth&&(o-=o+this.handlebarsContainer.offsetWidth-document.documentElement.clientWidth);var h=s.top,l=document.documentElement.clientHeight-(s.top+s.height),d=this.handlebarsContainer.offsetHeight<=l,u=this.handlebarsContainer.offsetHeight<=h;"bottom"===("top"===this.options.defaultMenuOrientation&&u?"top":"bottom"===this.options.defaultMenuOrientation&&d||l>h?"bottom":"top")?(a=s.top+s.height,d||(this.handlebarsContainer.style.height=l-3+"px"),this.options.handlebarsContainerClass.split(" ").forEach((function(e){t.handlebarsContainer.classList.add("".concat(e,"-bottom")),t.handlebarsContainer.classList.remove("".concat(e,"-top"))}))):(a=s.top-this.handlebarsContainer.offsetHeight,u||(this.handlebarsContainer.style.height=h-3+"px",a=3),this.options.handlebarsContainerClass.split(" ").forEach((function(e){t.handlebarsContainer.classList.add("".concat(e,"-top")),t.handlebarsContainer.classList.remove("".concat(e,"-bottom"))}))),this.handlebarsContainer.style.top="".concat(a,"px"),this.handlebarsContainer.style.left="".concat(o,"px"),this.handlebarsContainer.style.visibility="visible"}},{key:"getTextBeforeCursor",value:function(){var t=Math.max(0,this.cursorPos-this.options.maxChars);return this.quill.getText(t,this.cursorPos-t)}},{key:"onSomethingChange",value:function(){var t=this,e=this.quill.getSelection();if(null!=e){this.cursorPos=e.index;var n,i=this.getTextBeforeCursor(),s=(n=i,this.options.handlebarsDenotationChars.reduce((function(t,e){var i=n.lastIndexOf(e);return i>t.handlebarsCharIndex?{handlebarsChar:e,handlebarsCharIndex:i}:{handlebarsChar:t.handlebarsChar,handlebarsCharIndex:t.handlebarsCharIndex}}),{handlebarsChar:null,handlebarsCharIndex:-1})),a=s.handlebarsChar,o=s.handlebarsCharIndex;if(function(t,e,n){return t>-1&&!(n&&0!==t&&!e[t-1].match(/\s/g))}(o,i,this.options.isolateCharacter)){var r=this.cursorPos-(i.length-o);this.handlebarsCharPos=r;var h=i.substring(o+a.length);if(h.length>=this.options.minChars&&function(t,e){return e.test(t)}(h,this.getAllowedCharsRegex(a))){this.existingSourceExecutionToken&&(this.existingSourceExecutionToken.abandoned=!0),this.renderLoading();var l={abandoned:!1};this.existingSourceExecutionToken=l,this.options.source(h,(function(e,n){l.abandoned||(t.existingSourceExecutionToken=null,t.renderList(a,e,n))}),a)}else this.hideHandlebarsList()}else this.hideHandlebarsList()}}},{key:"getAllowedCharsRegex",value:function(t){return this.options.allowedChars instanceof RegExp?this.options.allowedChars:this.options.allowedChars(t)}},{key:"onTextChange",value:function(t,e,n){"user"===n&&this.onSomethingChange()}},{key:"onSelectionChange",value:function(t){t&&0===t.length?this.onSomethingChange():this.hideHandlebarsList()}},{key:"openMenu",value:function(t){var e=this.quill.getSelection(!0);this.quill.insertText(e.index,t),this.quill.blur(),this.quill.focus()}}]),n}();return t.register("modules/handlebars",m),m}(Quill);
